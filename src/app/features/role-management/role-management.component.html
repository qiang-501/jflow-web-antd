<!-- role-management.component.html -->
<div class="role-management-container">
  <div class="toolbar">
    <h2>角色管理</h2>
    <button nz-button nzType="primary" (click)="showAddModal()">
      <span nz-icon nzType="plus"></span>
      新增角色
    </button>
  </div>

  <nz-table
    #roleTable
    [nzData]="(roles$ | async) || []"
    [nzLoading]="(loading$ | async) || false"
    [nzPageSize]="10"
    [nzShowPagination]="true"
  >
    <thead>
      <tr>
        <th>角色名称</th>
        <th>角色编码</th>
        <th>描述</th>
        <th>层级结构</th>
        <th>权限数量</th>
        <th>创建时间</th>
        <th nzWidth="250px">操作</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let role of roleTable.data">
        <td>{{ role.name }}</td>
        <td>
          <nz-tag nzColor="purple">{{ role.code }}</nz-tag>
        </td>
        <td>{{ role.description || "-" }}</td>
        <td>{{ getRoleHierarchy(role, (roles$ | async) || []) }}</td>
        <td>
          <nz-tag nzColor="blue">{{ role.permissionIds.length }}</nz-tag>
        </td>
        <td>{{ role.createdAt | date: "short" }}</td>
        <td>
          <nz-space>
            <button
              *nzSpaceItem
              nz-button
              nzType="link"
              nzSize="small"
              (click)="showEditModal(role)"
            >
              <span nz-icon nzType="edit"></span>
              编辑
            </button>
            <button
              *nzSpaceItem
              nz-button
              nzType="link"
              nzSize="small"
              (click)="showPermissionModal(role)"
            >
              <span nz-icon nzType="safety"></span>
              分配权限
            </button>
            <button
              *nzSpaceItem
              nz-button
              nzType="link"
              nzSize="small"
              nzDanger
              nz-popconfirm
              nzPopconfirmTitle="确定要删除此角色吗?"
              (nzOnConfirm)="deleteRole(role.id)"
            >
              <span nz-icon nzType="delete"></span>
              删除
            </button>
          </nz-space>
        </td>
      </tr>
    </tbody>
  </nz-table>

  <!-- 添加/编辑角色模态框 -->
  <nz-modal
    [(nzVisible)]="isModalVisible"
    [nzTitle]="isEditMode ? '编辑角色' : '新增角色'"
    (nzOnCancel)="handleCancel()"
    (nzOnOk)="handleSubmit()"
    [nzOkLoading]="(loading$ | async) || false"
  >
    <ng-container *nzModalContent>
      <form nz-form [formGroup]="roleForm" nzLayout="vertical">
        <nz-form-item>
          <nz-form-label nzRequired>角色名称</nz-form-label>
          <nz-form-control nzErrorTip="请输入角色名称">
            <input
              nz-input
              formControlName="name"
              placeholder="请输入角色名称"
            />
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label nzRequired>角色编码</nz-form-label>
          <nz-form-control nzErrorTip="请输入角色编码">
            <input
              nz-input
              formControlName="code"
              placeholder="请输入角色编码"
            />
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label>描述</nz-form-label>
          <nz-form-control>
            <textarea
              nz-input
              formControlName="description"
              placeholder="请输入角色描述"
              [nzAutosize]="{ minRows: 3, maxRows: 6 }"
            ></textarea>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label>父角色（支持角色继承）</nz-form-label>
          <nz-form-control>
            <nz-tree-select
              formControlName="parentId"
              nzPlaceHolder="请选择父角色"
              [nzNodes]="(roleTreeNodes$ | async) || []"
              nzShowSearch
              nzAllowClear
              [nzExpandedKeys]="[]"
            ></nz-tree-select>
          </nz-form-control>
        </nz-form-item>
      </form>
    </ng-container>
  </nz-modal>

  <!-- 分配权限模态框 -->
  <nz-modal
    [(nzVisible)]="isPermissionModalVisible"
    nzTitle="分配权限"
    (nzOnCancel)="handlePermissionCancel()"
    (nzOnOk)="handlePermissionSubmit()"
    [nzOkLoading]="(loading$ | async) || false"
    nzWidth="600px"
  >
    <ng-container *nzModalContent>
      <div *ngIf="selectedRole" class="permission-info">
        <p><strong>角色：</strong>{{ selectedRole.name }}</p>
        <p><strong>编码：</strong>{{ selectedRole.code }}</p>
      </div>

      <form nz-form [formGroup]="permissionForm" nzLayout="vertical">
        <nz-form-item>
          <nz-form-label nzRequired>权限列表</nz-form-label>
          <nz-form-control nzErrorTip="请选择至少一个权限">
            <nz-select
              formControlName="permissionIds"
              nzMode="multiple"
              nzPlaceHolder="请选择权限"
              nzShowSearch
              [nzMaxTagCount]="3"
            >
              <nz-option
                *ngFor="let permission of permissions$ | async"
                [nzLabel]="permission.name + ' (' + permission.code + ')'"
                [nzValue]="permission.id"
              ></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </form>

      <div class="inheritance-info" *ngIf="selectedRole?.parentId">
        <nz-alert
          nzType="info"
          nzMessage="此角色将继承父角色的所有权限"
          nzShowIcon
        ></nz-alert>
      </div>
    </ng-container>
  </nz-modal>
</div>
